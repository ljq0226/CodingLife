
# 第三章 数据链路层
数据链路层是实现设备之间通信的非常重要的一层
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927142922.png)
局域网中的主机、交换机等都必须实现数据链路层

> 数据链路层使用的信道：(a) 点对点信道
>（b）广播信道
>![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927143021.png)

## 1 使用点对点信道的数据链路层
### 数据链路和帧
+ **链路** (link) 是一条无源的点到点的物理线路段，中间没有任何其他的交换结点，**一条链路只是一条通路的一个组成部分**
+ **数据链路** (data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
	+ 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。
	+ 一般的适配器都包括了数据链路层和物理层这两层的功能。
也有人采用另外的术语。这就是把链路分为物理链路和逻辑链路。
+ **物理链路**就是上面所说的链路。
+ **逻辑链路**就是上面的数据链路，是物理链路加上必要的**通信协议**。
早期的数据通信协议曾叫做通信规程 (procedure)。因此在数据链路层，规程和协议是同义语。
+ **帧** ：常常在两个对等的数据链路层之间画出一个**数字管道**，而在这条数字管道上传输的数据单位是帧，数据链路层不必考虑物理层如何实现比特传输的细节。甚至还可以更简单地设想好像是沿着两个数据链路层之间的水平方向把帧直接发送到对方。
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927143813.png)

### 三个基本问题

#### 封装成帧
**封装成帧 (framing)** 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。
首部和尾部的一个重要作用就是进行**帧定界**。
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220920154458.png)
当数据是由可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的帧定界符。
**控制字符 SOH** (Start Of Header) 放在一帧的最前面，表示帧的首部开始。另一个**控制字符 EOT** (End Of Transmission) 表示帧的结束。
#### 透明成帧
> **透明**：指某一个实际存在的事物看起来却好像不存在一样
> “在数据链路层透明传送数据”表示无论发送什么样的比特组合的数据，这些数据都能够按照原样没有差错地通过这个数据链路层。

 如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地“找到帧的边界”。
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220920155105.png)


解决方法：**字节填充** (byte stuffing) 或**字符填充** (character stuffing)。
+ 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(其十六进制编码是1B)。
+ 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。
+ 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。 
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927164710.png)

#### 差错检测
+ 在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率 BER** (Bit Error Rate)。
误码率与信噪比有很大的关系。
+ 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。 
+ 在数据链路层传送的帧中，广泛使用了**循环冗余检验 CRC** 的检错技术。
##### 循环冗余检验CRC
构造：
+ 由生成多项式确定“除数”。若生成多项式中x的最高次为R，则“除数”有R+1位
+ K个信息位+R个o，作为“被除数”
+ 被除数、除数进行“模二除”，得R位余数
+ K个信息位+R位余数=CRC码
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220928090123.png)
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220928090330.png)

校验：
+ 收到K+R位数据，与生成多项式模二除，计算R位余数余数
+ 为0，说明无错误
+ 余数非0，说明出错
检错、纠错能力
+ 可检测出所有奇数个错误;
+ 可检测出所有双比特的错误;
+ 可检测出所有小于等于校验位长度的连续错误;
+ 若选择合适的生成多项式，且2^R ≥ K+R+1，则可纠正单比特错








## 2 点对点协议PPP
+ 现在全世界使用最多的点对点数据链路层协议是点对点协议PPP(Point-to-point Protocol)
+ 用户使用拨号电话线接入英特网时，使用的也是PPP协议
### 特点
+ 简单 —— 这是首要的要求。
+ 封装成帧 —— 必须规定特殊的字符作为帧定界符。
+ 透明性 —— 必须保证数据传输的透明性。
+ 多种网络层协议 —— 能够在同一条物理链路上同时支持多种网络层协议。
+ 多种类型链路 —— 能够在多种类型的链路上运行。
+ 差错检测 —— 能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。

### 组成
PPP 协议有三个组成部分：
1. 一个将 IP 数据报封装到串行链路的方法。
2. 链路控制协议 LCP (Link Control Protocol)。
3. 网络控制协议 NCP (Network Control Protocol)。

### PPP协议的帧格式
+ PPP 帧的首部和尾部分别为 4 个字段和 2 个字段
+ 标志字段 **F = 0x7E** （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 **01111110**）
+ 地址字段 A 只置为 0xFF。地址字段实际上并不起作用。
控制字段 C 通常置为 0x03
+ PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927144802.png)
> PPP 有一个 2 个字节的协议字段。其值
+ 若为 0x0021，则信息字段就是 IP 数据报。
+ 若为 0x8021，则信息字段是网络控制数据。
+ 若为 0xC021，则信息字段是 PPP 链路控制数据。
+ 若为 0xC023，则信息字段是鉴别数据。
### 透明传输问题
+ 当 PPP 用在异步传输时，就使用一种特殊的字符填充法。
+ 当 PPP 用在同步传输链路时，协议规定采用硬件来完成比特填充（和 HDLC 的做法一样）。

### 字符填充法
将信息字段中出现的每一个 **0x7E** 字节转变成为 2 字节序列 (**0x7D, 0x5E**)。 
若信息字段中出现一个 **0x7D** 的字节, 则将其转变成为 2 字节序列 (**0x7D, 0x5D**)。
若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 **0x7D** 字节，同时将该字符的编码加以改变。 
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927145639.png)

### 零比特填充
+ PPP 协议用在 SONET/SDH 链路时，使用同步传输（一连串的比特连续传送）。这时 PPP 协议采用零比特填充方法来实现透明传输。
+ 在发送端，只要发现有 **5 个连续 1**，则立即**填入一个 0**。
+ 接收端对帧中的比特流进行扫描。每当发现 5 个连续1时，就把这 5 个连续 1 后的一个 0 删除。
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927150700.png)



 ## 3 使用广播信道的数据链路层
 
### 局域网的数据链路层
#### 特点
+ 网络为一个单位所拥有；
+ 地理范围和站点数目均有限。 
主要优点：
1. 具有**广播功能**，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
2. 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
3. 提高了系统的可靠性、可用性和残存性。
#### 拓扑结构
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927152543.png)


#### 媒体共享技术
##### 静态划分信道
1. 频分复用
2. 时分复用
3. 波分复用
4. 码分复用 
##### 动态媒体接入控制（多点接入）
1. 随机接入（如以太网）
2. 受控接入 ，如多点线路探询 (polling)，或轮询。  

#### 数据链路层的两个子层
+ 为了使数据链路层能更好地适应多种局域网标准，IEEE 802 委员会就将局域网的数据链路层拆成两个子层：
	+ **逻辑链路控制 LLC** (Logical Link Control)子层；
	+ **媒体接入控制 MAC** (Medium Access Control)子层。
+ 与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关。
+ 不管采用何种协议的局域网，对 LLC 子层来说都是透明的
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927153045.png)

> LLC已经不重要了，只需要MAC接入以太网即可

#### 适配器
网络接口板又称为**通信适配器** (adapter) 或**网络接口卡** NIC (Network Interface Card)，或“**网卡**”。 
适配器的重要功能：
1. 进行串行/并行转换。
2. 对数据进行缓存。
3. 在计算机的操作系统安装设备驱动程序。
4. 实现以太网协议。
>计算机通过适配器和局域网进行通信
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20220927154211.png)

+ 适配器从网络上每收到一个MAC帧就首先用硬件检查MAC帧中的MAC地址：
	+ 如果是发往本站的帧则收下，然后再进行其它的处理
	+ 否则就将此帧丢弃，不再进行其他的处理
+ 发往本站的帧包括
	+ 单播帧（一对一）
	+ 广播帧（一对全体）
	+ 多播帧（一对多）


#### 以太网的两个标准
**DIX Ethernet V2** 是世界上第一个局域网产品（以太网）的规约。
**IEEE 802.3** 是第一个 IEEE 的以太网标准。
DIX Ethernet V2 标准与 IEEE 的 802.3 标准只有很小的差别，因此可以将 802.3 局域网简称为“以太网”。
严格说来，“以太网”应当是指符合 DIX Ethernet V2 标准的局域网 。

### CSMA/CD协议

CSMA/CD 含义：**载波监听多点接入 / 碰撞检测**  (Carrier Sense Multiple Access with Collision Detection) 。
**多点接入** 表示许多计算机以多点接入的方式连接在一根总线上。
**载波监听**是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。 
总线上并没有什么“载波”。因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。
#### 碰撞检测
+ 碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小。
+ 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
+ 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。
+ 所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。
+ 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
+ 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20221004143013.png)
![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20221004143036.png)

CSMA CD不适合guanguan广域网 适合局域网


### MAC 层

#### MAC帧的格式
常用的以太网 MAC 帧格式有两种标准：
+ DIX Ethernet V2 标准
+ IEEE 的 802.3 标准
最常用的 MAC 帧是以太网 V2 的格式（如下）。

![](https://obs-pic-1309372570.cos.ap-chongqing.myqcloud.com/20221004145208.png)



### 扩展的以太网
